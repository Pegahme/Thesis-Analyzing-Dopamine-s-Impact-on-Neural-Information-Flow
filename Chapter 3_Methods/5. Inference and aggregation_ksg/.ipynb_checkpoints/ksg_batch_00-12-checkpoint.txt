#!/bin/bash
#SBATCH --job-name=00_ksg_mte_batch_50          
#SBATCH --account=kobelxwm_0000
#SBATCH --partition=gpu
#SBATCH --nodes=1
#SBATCH --ntasks=1                                # One Python process
#SBATCH --gpus=1                                  # One GPU per task
#SBATCH --cpus-per-gpu=4                          # Match OMP_NUM_THREADS=4
#SBATCH --mem=64G
#SBATCH --time=2-00:00:00
#SBATCH --array=0-68                              # 3 files Ã— 23 targets = 69 jobs
#SBATCH --output=logs/50_ksg_mte_batch_00_%A_%a.out
#SBATCH --error=logs/50_ksg_mte_batch_00_%A_%a.err

# Fail on errors, unset vars, and pipeline errors
set -euo pipefail
mkdir -p logs

echo "Running on $(hostname) at $(date)"

# --- Load environment (cluster-specific modules) ---
module purge
module load openmpi/5.0.5-d3ii4pq
module load python/3.11.7-watv22a
module load cuda/12.6.1-jr4ru3u                    # OpenCL impl may rely on CUDA stack

# Activate the venv with IDTxl + deps
source ~/myproject/idtxl_env_fixed/bin/activate

# Java for IDTxl/JIDT backends (some CMI estimators require it)
export JAVA_HOME=~/myproject/jdk/jdk-11.0.27+6
export LD_LIBRARY_PATH="$JAVA_HOME/lib/server:$LD_LIBRARY_PATH"

# Ensure consistent threading and immediate logging
export OMP_NUM_THREADS=4
export PYTHONUNBUFFERED=1

# --- Map array index -> (file, target) ---
NUM_TARGETS=23
FILE_INDEX=$((SLURM_ARRAY_TASK_ID / NUM_TARGETS))   # integer division
TARGET_INDEX=$((SLURM_ARRAY_TASK_ID % NUM_TARGETS)) # remainder in [0..22]

# Batch list: one absolute file path per line.
# For additional batches, create batch_01.txt, batch_02.txt, ...
# and update this variable accordingly in the corresponding Slurm script.
BATCH_FILE="/lustre/majlepy2/myproject/50_epochs_idtxl/batches/batch_00.txt"
files=($(cat "$BATCH_FILE"))

# Guard against index overflow if the list is shorter than expected
if [[ $FILE_INDEX -ge ${#files[@]} ]]; then
  echo "ERROR: FILE_INDEX=$FILE_INDEX out of bounds (only ${#files[@]} files)"
  exit 1
fi

# Select inputs for this array task
FILE="${files[$FILE_INDEX]}"
TARGET=$TARGET_INDEX

echo "SLURM_ARRAY_TASK_ID = $SLURM_ARRAY_TASK_ID"
echo "FILE_INDEX           = $FILE_INDEX"
echo "TARGET_INDEX         = $TARGET_INDEX"
echo "FILE                 = $FILE"
ls -lh "$FILE" || { echo "File not found: $FILE"; exit 1; }

# Helpful diagnostics: confirm Slurm's GPU assignment
echo "CUDA_VISIBLE_DEVICES: $CUDA_VISIBLE_DEVICES"
nvidia-smi

# --- Run analysis ---
python /home/majlepy2/myproject/ksg/ksg_mte_50.py \
  --input-file "$FILE" \
  --cmi-estimator OpenCLKraskovCMI \
  --target "$TARGET"

echo "Finished FILE=$FILE, TARGET=$TARGET"
